#
#
# ci.yml
# LearnCHANGELOG
#
# Created by maulana on 30/11/25.
#
name: CI

on:
  push:
    branches: [
      main, # production
      develop, # staging
      feature/*, # feature branches
      hotfix/* # hotfix branches
      ]

  pull_request:
    branches: ["main", "develop"]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

# ENVIRONMENT VARIABLES
env:
  LC_ALL: en_US.UTF-8
  LANG: en_US.UTF-8
  PROJECT_NAME: "LearnCHANGELOG.xcodeproj"
  BUILD_SCHEME: "LearnCHANGELOG"
  BUILD_CONFIG: "Debug"
  IS_PRODUCTION: "false" # default value

jobs:
  # Job 0: Setup environment berdasarkan branch
  setup:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      build-config: ${{ steps.determine-config.outputs.build-config }}
      simulator-name: ${{ steps.determine-config.outputs.simulator-name }}
      is-production: ${{ steps.determine-config.outputs.is-production }}
      environment: ${{ steps.determine-config.outputs.environment }}

    steps:
      - name: Determine Environment Configuration # Tentukan environment berdasarkan branch
        id: determine-config # langkah untuk menentukan konfigurasi
        run: |

          echo "Analyzing branch: ${{ github.ref }}"

          # Ekstrak branch name dari ref
          # BRANCH_NAME="${{ github.ref_name }}"

          # Untuk pull_request, gunakan head_ref (branch sumber)
          # Untuk push, gunakan ref_name
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BRANCH_NAME="${{ github.head_ref }}"
            echo "Pull request from branch: $BRANCH_NAME"
          else
            BRANCH_NAME="${{ github.ref_name }}"
            echo "Push to branch: $BRANCH_NAME"
          fi

          echo "Branch name: $BRANCH_NAME"

          if [[ "$BRANCH_NAME" == "main" ]]; then
            echo "PRODUCTION - main branch"
            echo "build-config=Release" >> $GITHUB_OUTPUT
            echo "simulator-name=iPhone 16 Pro" >> $GITHUB_OUTPUT
            echo "is-production=true" >> $GITHUB_OUTPUT
            echo "environment=production" >> $GITHUB_OUTPUT

          elif [[ "$BRANCH_NAME" == "develop" ]]; then
            echo "STAGING - develop branch"
            echo "build-config=Debug" >> $GITHUB_OUTPUT
            echo "simulator-name=iPhone 16 Pro" >> $GITHUB_OUTPUT 
            echo "is-production=false" >> $GITHUB_OUTPUT
            echo "environment=staging" >> $GITHUB_OUTPUT

          elif [[ "$BRANCH_NAME" =~ ^feature/ ]]; then
            echo "FEATURE - feature branch"
            echo "build-config=Debug" >> $GITHUB_OUTPUT
            echo "simulator-name=iPhone 16" >> $GITHUB_OUTPUT
            echo "is-production=false" >> $GITHUB_OUTPUT
            echo "environment=development" >>$GITHUB_OUTPUT

          elif [[ "$BRANCH_NAME" =~ ^hotfix/ ]]; then
            echo "HOTFIX - hotfix branch"
            echo "build-config=Release" >> $GITHUB_OUTPUT
            echo "simulator-name=iPhone 16 Pro" >> $GITHUB_OUTPUT
            echo "is-production=true" >> $GITHUB_OUTPUT
            echo "environment=production" >> $GITHUB_OUTPUT

          else
            echo "UNKNOWN branch type" # default to Debug
            echo "build-config=Debug" >> $GITHUB_OUTPUT
            echo "simulator-name=iPhone 16 Pro" >> $GITHUB_OUTPUT
            echo "is-production=false" >> $GITHUB_OUTPUT
            echo "environment=unknown" >> $GITHUB_OUTPUT
          fi
          
          echo "Configuration determined successfully"

  # Job 1: Test di berbagai Xcode versions     
  test-unit:
    name: Unit Testing (Xcode ${{ matrix.xcode }}) # Menjalankan unit tests di berbagai versi Xcode
    runs-on: macos-15
    needs: setup # menentukan environment berdasarkan branch
    strategy:
      fail-fast: false
      matrix:
        xcode: ["16.4"] # , "16.2", "16.0"
    env:
      BUILD_CONFIG: ${{ needs.setup.outputs.build-config }}
      SIMULATOR_NAME: ${{ needs.setup.outputs.simulator-name }}

    steps:
      - name: Checkout # Checkout kode sumber
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Untuk mendapatkan semua history untuk changelog
      
      - name: Show Build Configuration # Menampilkan konfigurasi build yang digunakan
        run: |
          echo "Build Configuration: $BUILD_CONFIG"
          echo "Environment: ${{ needs.setup.outputs.environment }}"
          echo "Simulator Name: $SIMULATOR_NAME"
          echo "Xcode Version: ${{ matrix.xcode }}"
          echo "Project: $PROJECT_NAME"
          echo "Scheme: $BUILD_SCHEME"

      - name: Select Xcode ${{ matrix.xcode }}
        run: sudo xcode-select -switch /Applications/Xcode_${{ matrix.xcode }}.app

      - name: List available devices
        run: xcrun simctl list devices available

      - name: Download iOS Platform # Pastikan platform iOS terunduh
        run: xcodebuild -downloadPlatform iOS # Mengunduh platform iOS jika belum ada

      - name: Set IgnoreFileSystemDeviceInodeChanges flag # Mengatasi masalah simulator yang sering crash
        run: defaults write com.apple.dt.XCBuild IgnoreFileSystemDeviceInodeChanges -bool YES

      - name: Pick Simulator ID # Memilih simulator iPhone 16 Pro yang tersedia
        run: |
          SIM=$(xcrun simctl list devices | grep "$SIMULATOR_NAME (" | grep -v unavailable | head -1 | awk -F '[()]' '{print $2}')
          echo "SIMULATOR_ID=$SIM" >> $GITHUB_ENV

          # Fallback jika simulator tidak ditemukan
          if [ -z "$SIM" ]; then
            echo "Simulator $SIMULATOR_NAME not found, using fallback"
            SIM=$(xcrun simctl list devices | grep "iPhone 16 Pro (" | grep -v unavailable | head -1 | awk -F '[()]' '{print $2}')
          fi
          
          echo "SIMULATOR_ID=$SIM" >> $GITHUB_ENV
          echo "Selected Simulator ID: $SIM ($SIMULATOR_NAME)"

      - name: Cache DerivedData # Cache untuk mempercepat build
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: dd-${{ matrix.xcode }}-${{ hashFiles('**/*.swift') }}
      
      - name: Show Environment # Menampilkan versi Xcode dan Swift
        run: |
          echo "Xcode: ${{ matrix.xcode }}"
          xcodebuild -version # Menampilkan versi Xcode
          swift --version # Menampilkan versi Swift
          echo "Project: $PROJECT_NAME"
          echo "Scheme: $BUILD_SCHEME"
          echo "Build Configuration: $BUILD_CONFIG"
      
      #- name: Install xcpretty #Untuk mendapatkan pesan error lengkapnya (optional)
      #  run: gem install xcpretty

      # logging dengan `tee build.log`
      - name: Build Project # Membangun proyek untuk memastikan tidak ada error build
        run: |
          echo "Building project for validation..."
          xcodebuild build \
            -project $PROJECT_NAME \
            -scheme $BUILD_SCHEME \
            -destination "platform=iOS Simulator,id=$SIMULATOR_ID" \
            -configuration ${{ needs.setup.outputs.build-config }} \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO | xcpretty --color || tee build.log
            
            if [ ${PIPESTATUS[0]} -ne 0 ]; then
               echo "Build failed. Check build.log for details."
               exit 1
            fi

      - name: Run Unit Tests # UNIT TESTING!
        run: |
          echo "Running unit tests..."
          
          rm -rf ~/Library/Developer/Xcode/DerivedData/*

          set -o pipefail # Untuk menangkap exit code dari xcodebuild

          xcodebuild clean test \
            -project $PROJECT_NAME \
            -scheme $BUILD_SCHEME \
            -destination "platform=iOS Simulator,id=$SIMULATOR_ID" \
            -configuration ${{ needs.setup.outputs.build-config }} \
            -skip-testing:LearnCHANGELOGUITests \
            -only-testing:LearnCHANGELOGTests \
            ENABLE_TESTABILITY=YES \
            GCC_PREPROCESSOR_DEFINITIONS='$(inherited) ENABLE_TESTABILITY=1' \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO 2>&1 | tee test.log

            # Cek exit code
            if [ ${PIPESTATUS[0]} -ne 0 ]; then
              echo "Unit tests failed. Check test.log for details."
              exit 1
            fi

            # Buat report html dari log (opsional)
            if [ -f "test.log" ]; then
              # Convert log to html report sederhana
              echo "<html><body><pre>" > test-report.html
              cat test.log >> test-report.html
              echo "</pre></body></html>" >> test-report.html
            fi

      
      - name: Upload Test Report # Unggah laporan pengujian sebagai artefak
        uses: actions/upload-artifact@v4
        with:
          name: test-report-xcode-${{ matrix.xcode }}-${{ env.BUILD_CONFIG }}
          path: test-report.html
          retention-days: 7 # Simpan artefak selama 7 hari

      - name: Upload Logs (if failed) # Unggah log jika terjadi kegagalan
        if: failure() # Hanya jika job gagal
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-xcode-${{ matrix.xcode }} # Nama artefak log
          path: |
           *.log
           build.log # Sesuaikan dengan lokasi log file
          retention-days: 7 # Simpan log selama 7 hari

  # Job 2: Release Build (hanya di main branch)
  release: # Release Build untuk produksi
    name: Release Build # on main branch
    runs-on: macos-15 # Menjalankan di macOS terbaru
    needs: [setup, test-unit] # pastikan job test-unit selesai terlebih dahulu
    #if: github.ref == 'refs/heads/main' #apakah github.ref sama dengan refs/heads/main
    if: needs.setup.outputs.is-production == 'true' # Hanya jalankan jika ini adalah build produksi

    env:
      BUILD_CONFIG: ${{ needs.setup.outputs.build-config }}
      
    steps:
      - name: Checkout # Checkout kode sumber
        uses: actions/checkout@v4

      - name: Show Release Info
        run: |
          echo "RELEASE BUILD INFORMATION"
          echo "Environment: ${{ needs.setup.outputs.environment }}"
          echo "Build Configuration: $BUILD_CONFIG"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
      
      - name: Select Xcode 16.4 # Pilih Xcode 16.4 untuk build rilis
        run: sudo xcode-select --switch /Applications/Xcode_16.4.app
      
      - name: Validate Release Build # Build validasi sebelum archip
        run: |
          echo "Validating release build configuration..."
          xcodebuild build \
            -project $PROJECT_NAME \
            -scheme $BUILD_SCHEME \
            -configuration Release \
            -destination "generic/platform=iOS" \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO | tee build-validate-output.log || {
              echo "Release build validation failed. Check the build log for details."
              exit 1
            }

          echo "Release build configuration validated successfully!"
          
      - name: Build Release Archive # Membangun arsip rilis tanpa penandatanganan kode
        run: |
          echo "Validating release build..."
          xcodebuild clean archive \
            -project $PROJECT_NAME \
            -scheme $BUILD_SCHAME \
            -configuration Release \
            -archivePath build/LearnCHANGELOG.xcarchive \
            -destination "generic/platform=iOS" \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_ALLOWED=NO \
            | tee archive.log
              echo "Release build failed. Check the build log for details."
          
          echo "Release build validated successfully!"
            
      - name: Upload Archive Artifact # Unggah arsip build sebagai artefak
        uses: actions/upload-artifact@v4
        with:
          name: LearnCHANGELOG-Release-${{ github.sha }} # Nama artefak dengan SHA komit
          path: |
           build/LearnCHANGELOG.xcarchive # Jalur ke arsip yang akan diunggah
           release-build.log # Jalur ke log build rilis
           archive.log # Jalur ke log arsip
          retention-days: 30 # Simpan artefak selama 30 hari
  
  
  build-dev:
    name: Development Build # on develop branch
    runs-on: macos-15 # Menjalankan di macOS terbaru
    needs: [setup, test-unit] # pastikan job test-unit selesai terlebih dahulu
    if: github.ref == 'refs/heads/develop' #apakah github.ref sama dengan refs/heads/develop

    env:
      BUILD_CONFIG: ${{ needs.setup.outputs.build-config }}
      
    steps:
      - name: Checkout # Checkout kode sumber
        uses: actions/checkout@v4

      - name: Show Development Build Info
        run: |
          echo "DEVELOPMENT BUILD INFORMATION"
          echo "Environment: ${{ needs.setup.outputs.environment }}"
          echo "Build Configuration: $BUILD_CONFIG"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
      
      - name: Select Xcode 16.4 # Pilih Xcode 16.4 untuk build development
        run: sudo xcode-select --switch /Applications/Xcode_16.4.app
      
      - name: Build Development Build # Membangun build development 
        run: |
          echo "Building development build..."
          xcodebuild clean build \
            -project $PROJECT_NAME \
            -scheme $BUILD_SCHAME \
            -configuration $BUILD_CONFIG \
            -destination "generic/platform=iOS" \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_ALLOWED=NO \
            | tee dev-build.log
              echo "Development build failed. Check the build log for details."
          
          echo "Development build completed successfully!"
            
      - name: Upload Development Build Artifact # Unggah build development sebagai artefak
        uses: actions/upload-artifact@v4
        with:
          name: LearnCHANGELOG-${{ env.BUILD_CONFIG }}-dev-${{ github.sha }}
          path: ./build/Build/Products/$BUILD_CONFIG-iphoneos/
          retention-days: 7
