#
#
# ci.yml
# LearnCHANGELOG
#
# Created by west on 30/11/25.
#
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: ["*"]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # Job 1: Test di berbagai Xcode versions
  test:
    name: Test (Xcode ${{ matrix.xcode }})
    runs-on: macos-15
    strategy:
      fail-fast: false
      matrix:
        xcode: ["16.4"] # , "16.2", "16.0"
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Select Xcode ${{ matrix.xcode }}
        run: sudo xcode-select -switch /Applications/Xcode_${{ matrix.xcode }}.app

      - name: List available devices
        run: xcrun simctl list devices available

      - name: Download iOS Platform
        run: xcodebuild -downloadPlatform iOS

      - name: Set IgnoreFileSystemDeviceInodeChanges flag
        run: defaults write com.apple.dt.XCBuild IgnoreFileSystemDeviceInodeChanges -bool YES

      - name: Pick Simulator ID
        run: |
          SIM=$(xcrun simctl list devices | grep "iPhone 16 Pro (" | grep -v unavailable | head -1 | awk -F '[()]' '{print $2}')
          echo "SIMULATOR_ID=$SIM" >> $GITHUB_ENV


      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: dd-${{ matrix.xcode }}-${{ hashFiles('**/*.swift') }}
      
      - name: Show Environment
        run: |
          echo "Xcode: ${{ matrix.xcode }}"
          xcodebuild -version
          swift --version
      
      - name: Install xcpretty #Untuk mendapatkan pesan error lengkapnya
        run: gem install xcpretty

      - name: Run Tests
        run: |
          xcodebuild clean test \
            -project LearnCHANGELOG.xcodeproj \
            -scheme LearnCHANGELOG \
            -destination "id=$SIMULATOR_ID" \
            -skip-testing:LearnCHANGELOGUITests \
            -only-testing:LearnCHANGELOGTests \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
      
      - name: Upload Logs (if failed)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-xcode-${{ matrix.xcode }}
          path: "*.log"
          retention-days: 7

  # Job 2: Release Build (hanya di main branch)
  release:
    name: Release Build
    runs-on: macos-15
    if: github.ref == 'refs/heads/main'
    needs: test
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Select Xcode 16.4
        run: sudo xcode-select --switch /Applications/Xcode_16.4.app
      
      - name: Build Release Archive
        run: |
          xcodebuild clean archive \
            -project LearnCHANGELOG.xcodeproj \
            -scheme LearnCHANGELOG \
            -configuration Release \
            -archivePath build/LearnCHANGELOG.xcarchive \
            -destination "generic/platform=iOS" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO
      
      - name: Upload Archive
        uses: actions/upload-artifact@v4
        with:
          name: LearnCHANGELOG-Release-${{ github.sha }}
          path: build/LearnCHANGELOG.xcarchive
          retention-days: 30
