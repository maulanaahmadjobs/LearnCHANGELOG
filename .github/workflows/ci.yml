#
#
# ci.yml
# LearnCHANGELOG
#
# Created by west on 30/11/25.
#
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: ["*"]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build:
    name: Build (Xcode ${{ matrix.xcode }} - ${{ matrix.platform }})
    runs-on: macos-15
    strategy:
      matrix:
        command: [build, test]  # "build" atau "test"
        platform: [IOS, MACOS]
        xcode: ["16.4", "16.2"]
        include:
          - platform: IOS
            destination: "platform=iOS Simulator"
          - platform: MACOS  
            destination: "platform=macOS"
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Select Xcode ${{ matrix.xcode }}
        run: sudo xcode-select -s /Applications/Xcode_${{ matrix.xcode }}.app
      
      - name: Show Environment
        run: |
          echo "Xcode: ${{ matrix.xcode }}"
          echo "Platform: ${{ matrix.platform }}"
          echo "Command: ${{ matrix.command }}"
          xcodebuild -version
      
      - name: Install iOS Simulator Runtime (if needed)
        if: matrix.platform == 'IOS' && matrix.xcode >= '16.0'
        run: |
          sudo xcodebuild -downloadPlatform iOS 2>/dev/null || true
          sleep 5
      
      # FIXED: Build command yang benar
      - name: Run ${{ matrix.command }}
        run: |
          xcodebuild clean ${{ matrix.command }} \
            -project LearnCHANGELOG.xcodeproj \
            -scheme LearnCHANGELOG \
            -destination "${{ matrix.destination }}" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            SWIFT_VERSION=5.0 \
            IPHONEOS_DEPLOYMENT_TARGET=15.0