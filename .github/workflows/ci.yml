#
#
# ci.yml
# LearnCHANGELOG
#
# Created by west on 30/11/25.
#
#
name: CI
on:
  push:
    branches: [main]
  pull_request:
    branches: ["*"]
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true
permissions:
  contents: read
jobs:
  test:
    name: Test (Xcode ${{ matrix.xcode }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Xcode 16.x (macOS 15)
          - xcode: "16.2"
            os: macos-15
            ios: "18.0"
            fallback_ios: "17.5"
          - xcode: "16.0"
            os: macos-15
            ios: "18.0"
            fallback_ios: "17.5"
          # Xcode 15.x (macOS 14)
          - xcode: "15.4"
            os: macos-14
            ios: "17.5"
            fallback_ios: "17.2"
          - xcode: "15.2"
            os: macos-14
            ios: "17.2"
            fallback_ios: "17.0"
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Select Xcode ${{ matrix.xcode }}
        run: sudo xcode-select -s /Applications/Xcode_${{ matrix.xcode }}.app
      
      - name: Show Environment
        run: |
          echo "Environment Info"
          echo "Xcode: ${{ matrix.xcode }}"
          echo "macOS: ${{ matrix.os }}"
          echo "Target iOS: ${{ matrix.ios }}"
          echo ""
          xcodebuild -version
          swift --version
      
      - name: Show Available Destinations
        run: |
          echo "Available iOS Runtimes:"
          xcrun simctl list runtimes iOS
          echo ""
          echo "Available Destinations:"
          xcodebuild -project LearnCHANGELOG.xcodeproj \
            -scheme LearnCHANGELOG \
            -showdestinations
      
      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: dd-${{ matrix.os }}-${{ matrix.xcode }}-${{ hashFiles('**/*.swift') }}
          restore-keys: |
            dd-${{ matrix.os }}-${{ matrix.xcode }}-
            dd-${{ matrix.os }}-
      
      - name: Install xcpretty
        run: gem install xcpretty
      
      - name: Run Tests
        run: |
          # Try primary iOS version
          xcodebuild clean test \
            -project LearnCHANGELOG.xcodeproj \
            -scheme LearnCHANGELOG \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=${{ matrix.ios }}' \
            -skip-testing:LearnCHANGELOGUITests \
            -only-testing:LearnCHANGELOGTests \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO | xcpretty || \
          # Fallback to secondary iOS version
          xcodebuild clean test \
            -project LearnCHANGELOG.xcodeproj \
            -scheme LearnCHANGELOG \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=${{ matrix.fallback_ios }}' \
            -skip-testing:LearnCHANGELOGUITests \
            -only-testing:LearnCHANGELOGTests \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO | xcpretty
      
      - name: Upload Logs (if failed)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-${{ matrix.os }}-xcode-${{ matrix.xcode }}
          path: |
            *.log
            ~/Library/Logs/DiagnosticReports/*.crash
          retention-days: 7
  
  release:
    name: Release Build
    runs-on: macos-15
    if: github.ref == 'refs/heads/main'
    needs: test
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Select Xcode 16.2
        run: sudo xcode-select -s /Applications/Xcode_16.2.app
      
      - name: Build Release Archive
        run: |
          xcodebuild clean archive \
            -project LearnCHANGELOG.xcodeproj \
            -scheme LearnCHANGELOG \
            -configuration Release \
            -archivePath build/LearnCHANGELOG.xcarchive \
            -destination "generic/platform=iOS" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO
      
      - name: Upload Archive
        uses: actions/upload-artifact@v4
        with:
          name: LearnCHANGELOG-Release-${{ github.sha }}
          path: build/LearnCHANGELOG.xcarchive
          retention-days: 30