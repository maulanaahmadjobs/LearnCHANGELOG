#
#
# ci.yml
# LearnCHANGELOG
#
# Created by west on 30/11/25.
#
#
# ci.yml
# LearnCHANGELOG
#
# Created by west on 30/11/25.
#
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: ["*"]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # Job 1: Test di berbagai Xcode versions
  test:
    name: Test (Xcode ${{ matrix.xcode }})
    runs-on: macos-15
    strategy:
      fail-fast: false
      matrix:
        xcode: ["16.4", "16.2"]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Select Xcode ${{ matrix.xcode }}
        run: sudo xcode-select -s /Applications/Xcode_${{ matrix.xcode }}.app

      - name: List simulators
        run: xcrun simctl list devices

      # grep "iPhone 16 (" #Filter simulator yang namanya mengandung “iPhone 16 (“
      # grep -v unavailable #Hilangkan simulator yang “unavailable”
      # head -1 Ambil simulator pertama
      # awk -F '[()]' '{print $2}' #Mengambil teks antara tanda kurung pertama #iPhone 16 (A2BF07D1-D6FB-41BE-AE0E-F0D8F89C31EF) 
      # SIMULATOR_ID #A2BF07D1-D6FB-41BE-AE0E-F0D8F89C31EF
      # Simpan ID ke variabel environment GitHub #echo "SIMULATOR_ID=$SIM" >> $GITHUB_ENV
      - name: Set simulator
        run: |
          SIM=$(xcrun simctl list devices | grep -E "iPhone 15 " | grep -v unavailable | tail -1 | awk -F '[()]' '{print $(NF-1)}')
          echo "SIMULATOR_ID=$SIM" >> $GITHUB_ENV

      - name: Validate simulator ID
        run: |
          if [ -z "$SIMULATOR_ID" ]; then
          echo "No simulator found! List of devices:"
          xcrun simctl list devices
          exit 1
       fi
          echo "Using simulator: $SIMULATOR_ID"


      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: dd-${{ matrix.xcode }}-${{ hashFiles('**/*.swift') }}
      
      - name: Show Environment
        run: |
          echo "Xcode: ${{ matrix.xcode }}"
          xcodebuild -version
          swift --version
      
      - name: Install xcpretty #Untuk mendapatkan pesan error lengkapnya
        run: gem install xcpretty

      - name: Run Tests
        run: |
          xcodebuild clean test \
            -project LearnCHANGELOG.xcodeproj \
            -scheme LearnCHANGELOG \
            -destination "platform=iOS Simulator,id=${SIMULATOR_ID}" \
            -skip-testing:LearnCHANGELOGUITests \
            -only-testing:LearnCHANGELOGTests \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
      
      - name: Upload Logs (if failed)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-xcode-${{ matrix.xcode }}
          path: "*.log"
          retention-days: 7

  # Job 2: Release Build (hanya di main branch)
  release:
    name: Release Build
    runs-on: macos-15
    if: github.ref == 'refs/heads/main'
    needs: test
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Select Xcode 16.4
        run: sudo xcode-select -s /Applications/Xcode_16.4.app
      
      - name: Build Release Archive
        run: |
          xcodebuild clean archive \
            -project LearnCHANGELOG.xcodeproj \
            -scheme LearnCHANGELOG \
            -configuration Release \
            -archivePath build/LearnCHANGELOG.xcarchive \
            -destination "generic/platform=iOS" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO
      
      - name: Upload Archive
        uses: actions/upload-artifact@v4
        with:
          name: LearnCHANGELOG-Release-${{ github.sha }}
          path: build/LearnCHANGELOG.xcarchive
          retention-days: 30